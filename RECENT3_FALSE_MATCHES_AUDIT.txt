AUDIT REPORT: False Matches in recent3.py
Root Cause Analysis - Same college_id matched to MULTIPLE addresses in same state

File: /Users/kashyapanand/Public/New/recent3.py (23,263 lines)
Date: 2025-11-09

================================================================================
EXECUTIVE SUMMARY
================================================================================

ROOT CAUSE: The matching pipeline correctly validates addresses (via 
pass4_final_address_filtering), but when building link tables in 
rebuild_state_course_college_link_text(), it does NOT enforce the same 
address validation. This creates false matches.

EVIDENCE: The rebuild_state_course_college_link_text() function (lines 
9270-9419) explicitly detects this pattern and flags it as "FALSE MATCH" 
(line 9407).

================================================================================
ROOT CAUSES IDENTIFIED
================================================================================

ROOT CAUSE #1: Inconsistent Address Validation in pass4_final_address_filtering()
Location: Lines 12931-13019
Problem: Addresses with ANY keyword overlap are accepted, even unvalidated ones

CRITICAL CODE (lines 13009-13016):
    else:
        # Specific college with NO address match - STILL INCLUDE!
        match['address_score'] = 0
        match['address_validated'] = False
        filtered_matches.append(match)  # ‚Üê PROBLEM: Unvalidated still accepted

Impact: address_validated=False matches are still passed through and saved to database


ROOT CAUSE #2: No Deduplication by Address When Updating seat_data
Location: match_and_link_parallel() line 13919
Problem: Results with same college_id but different addresses all saved

CRITICAL CODE (line 13919):
    results_df.to_sql(table_name, conn, if_exists='replace', index=False)

Impact: If matching assigned same master_college_id to multiple addresses, 
        this is recorded as-is with no validation


ROOT CAUSE #3: pass4_final_address_filtering NOT Called in All Matching Paths
Location: Multiple functions (lines 8583-8905, 13735-14012)

WHERE CALLED:
  - Line 7358: match_regular_course() ‚úÖ CALLED

WHERE NOT CALLED:
  - Lines 8583-8656: Tier 1 exact/primary matching (SQL only)
  - Lines 8702-8736: Tier 2 candidate selection (SQL only)  
  - Lines 8809-8905: Tier 2 post-processing (Python, NO explicit Pass 4)
  - Lines 13735-14012: Parallel batch processing (NO Pass 4 validation)

Impact: Multiple code paths save matches without address filtering


ROOT CAUSE #4: composite_college_key Missing in Master Data
Location: Lines 12045-12061
Problem: When composite_college_key empty, fallback loses address context

FALLBACK CODE (lines 12054-12060):
    if composite_key and ',' in composite_key:
        candidate_name = self.extract_college_name_from_composite_key(composite_key)
    else:
        # FALLBACK: Uses just college_name (ignores address)
        candidate_name = self.normalize_text(candidate.get('name', ''))
        candidate_normalized = candidate_name  # ‚Üê No address context!

Impact: Multiple campuses with same name become indistinguishable


ROOT CAUSE #5: Address Keyword Matching Too Flexible  
Location: Lines 13092-13158, 12985-13019
Problem: Even 1 common keyword counts as address match

MATCHING CODE (lines 12997):
    if len(common_keywords) > 0:  # ‚Üê Even 1 keyword is enough!
        match['address_score'] = len(common_keywords)
        match['address_validated'] = True
        filtered_matches.append(match)

Example: "KADAPA" vs "KADAPA DISTRICT" ‚Üí counts as match
         "RIMS, KADAPA" vs "KADAPA" ‚Üí counts as match

Impact: Weak address validation allows false positives


ROOT CAUSE #6: Missing Address Validation Gate Before Database Writes
Location: Lines 13863-13912 in match_and_link_parallel()
Problem: No deduplication by (college_id + state + address) before saving

MERGE LOGIC (lines 13863-13912):
    for idx, new_row in results_df.iterrows():
        # Preserve manual mappings
        # But NO check for:
        # - Whether address matches were validated  
        # - Whether multiple addresses are assigned same college_id
        # - Whether college_id is consistent with previous matches

Impact: Multiple records with same college_id but different addresses saved

================================================================================
CRITICAL CODE LOCATIONS - INSERT/UPDATE POINTS
================================================================================

PRIMARY DATA PERSISTENCE POINTS:

Location | Method | Table | Validation
---------|--------|-------|------------
Line 8435 | match_and_link_streaming() | {table}_linked | ‚ùå NO
Line 8973 | match_and_link_database_driven() | temp_tier2_results | ‚ùå NO  
Line 9055 | match_and_link_database_driven() | temp_tier3_results | ‚ùå NO
Line 13919 | match_and_link_parallel() | seat_data | ‚ùå NO
Line 14012 | match_and_link_parallel() | seat_data (PASS 2) | ‚ùå NO

LINK TABLE BUILDS (detect but don't prevent):

Location | Method | Table | Detection
---------|--------|-------|----------
Line 9237 | rebuild_college_course_link() | college_course_link | ‚úÖ YES (can't fix)
Line 9328 | rebuild_state_course_college_link_text() | state_course_college_link_text | ‚úÖ YES (detects false matches)

================================================================================
FALSE MATCH DETECTION (Lines 9358-9412)
================================================================================

DETECTED IN: rebuild_state_course_college_link_text()

The code FINDS false matches with this query (lines 9360-9376):

SELECT college_id, normalized_state, course_id,
       COUNT(*) as address_variations,
       ...
FROM state_course_college_link_text
GROUP BY college_id, normalized_state, course_id
HAVING COUNT(*) > 1  -- Multiple addresses for same college!

REPORTS ISSUE (lines 9383-9385):
    console.print(f"[red]üö® CRITICAL DATA QUALITY ISSUE: Found {len(conflicts)} FALSE MATCH patterns![/red]")
    console.print(f"[yellow]   Pattern: Same college_id matched to DIFFERENT physical locations[/yellow]")

BUT: Only DETECTS and reports, does NOT FIX or PREVENT

================================================================================
PROBLEMATIC CODE PATHS
================================================================================

PATH 1: Database-Driven Tier 2 Without Pass 4 (Lines 8702-8905)

    # Create temp table with candidates
    cur.executescript(f"""
        ...JOIN masterdb.state_college_link scl ON 1=1...
    """)
    
    # Python post-processing (NO PASS 4!)
    for candidate in group.itertuples(index=False):
        # Strategies: Prefix, Fuzzy, etc.
        # NO pass4_final_address_filtering() call!
        # Results written directly

FIX NEEDED: Call pass4_final_address_filtering() before accepting matches


PATH 2: Parallel Batch Processing Without Deduplication (Lines 13735-14034)

    # Process in parallel
    with ThreadPoolExecutor(...) as executor:
        batch_results = future.result()
        all_results.extend(batch_results)  # ‚Üê No dedup by address!
    
    # Save to database
    results_df.to_sql(table_name, conn, if_exists='replace')

FIX NEEDED: Deduplicate by (college_id + state + address) before saving


PATH 3: Pass 4 Not Enforced for Unvalidated Matches (Lines 13009-13016)

    else:
        # Specific college with NO address match - STILL INCLUDE!
        match['address_score'] = 0
        match['address_validated'] = False
        filtered_matches.append(match)  # ‚Üê ACCEPTS UNVALIDATED!

FIX NEEDED: Enforce address_validated==True before returning from matching


PATH 4: Multiple Candidates Not Single-Matched (Lines 12123-12124)

    # Use name-filtered candidates (may have multiple names)
    candidates = name_filtered_candidates
    
    # May contain 3+ colleges with same name, different addresses
    # Pass 4 should filter to 1, but it's OPTIONAL!

FIX NEEDED: Make Pass 4 mandatory when multiple candidates exist

================================================================================
SUMMARY: ADDRESS VALIDATION FLOW
================================================================================

Stage | Function | Address Checked | Enforced | Notes
------|----------|-----------------|----------|------
Matching Stage 1 | match_regular_course() | ‚úÖ Yes (Pass 4) | ‚úÖ Yes | Optional if no address
Matching Stage 2 | match_college_ultra_optimized() | ‚úÖ Yes | ‚ö†Ô∏è Partial | Through name filtering
Matching Stage 3 | pass3_college_name_matching() | ‚úÖ Yes | ‚ö†Ô∏è Weak | Keyword overlap too low
Matching Stage 4 | pass4_final_address_filtering() | ‚úÖ Yes | ‚ö†Ô∏è Optional | Can be skipped if no address
Database Matching | match_and_link_database_driven() | ‚ö†Ô∏è Partial | ‚ùå NO | SQL-based, no Pass 4
Batch Processing | match_and_link_parallel() | ‚ö†Ô∏è Partial | ‚ùå NO | Through process_batch()
Saving Results | to_sql() to seat_data | ‚ùå NO | ‚ùå NO | No deduplication
Link Table Build | rebuild_state_course_college_link_text() | ‚úÖ Yes | ‚ùå NO | Detects false matches but can't prevent

================================================================================
COMPOSITE_COLLEGE_KEY STATUS
================================================================================

QUESTION: Is composite_college_key populated in master database?

IF YES (but not fully populated):
  - Fallback logic (lines 12054-12060) triggered for some colleges
  - Address context lost for those colleges
  - Disambiguation fails

IF NO (not populated at all):
  - Entire composite key strategy cannot work
  - All address validation depends on fallback to address column
  - No guarantee address column matches composite key format

ACTION: Check master database schema
  - medical_colleges.composite_college_key
  - dental_colleges.composite_college_key  
  - dnb_colleges.composite_college_key

================================================================================
INTEGRITY VALIDATION CHECK (Lines 9421-9576)
================================================================================

Check 2: College ID + Address Uniqueness (Lines 9481-9525)

DETECTS VIOLATIONS with query:

SELECT master_college_id, state,
       COUNT(DISTINCT address) as address_count
FROM seat_data
GROUP BY master_college_id, state
HAVING COUNT(DISTINCT address) > 1  -- ‚Üê THE FALSE MATCH SYMPTOM!

REPORTS (line 9507-9508):
  [red]‚ùå FAILED: {N} colleges have MULTIPLE addresses in same state[/red]
  [red]This is the FALSE MATCH problem![/red]

This is the SYMPTOM. The root cause is address validation not being 
enforced BEFORE saving to database.

================================================================================
RECOMMENDATIONS TO FIX
================================================================================

1. IMMEDIATE (Lines 13863-13912):
   Add deduplication gate in match_and_link_parallel():
   - Before saving results, check for (college_id + state + address) conflicts
   - For each college_id+state group with multiple addresses:
     - Keep highest confidence match
     - Reject others with warning

2. CRITICAL (Lines 12931-13019):
   Make Pass 4 address validation mandatory:
   - Never return unvalidated matches when multiple candidates exist
   - Return empty list if no address-validated match found
   - Enforce minimum keyword overlap (1‚Üí2) for generic colleges

3. HIGH (Lines 8809-8905):
   Add Pass 4 validation to database-driven Tier 2:
   - After Python post-processing, call pass4_final_address_filtering()
   - Ensure results pass address validation before saving

4. HIGH (Line 12045-12061):
   Fix composite_college_key fallback:
   - Verify composite_college_key is populated for all colleges
   - If missing, populate using college name + canonical address
   - Update fallback to handle missing key gracefully

5. MEDIUM (Lines 13092-13158):
   Strengthen address keyword matching:
   - Require ALL master keywords in seat address (not just ANY)
   - Increase minimum threshold from 1 to 2 keywords
   - Add exact address matching as first strategy

6. MEDIUM (Lines 9055, 8973):
   Add Pass 4 to Tier 2/3 processing:
   - Call pass4_final_address_filtering() after Tier 3
   - Before saving temp_tier3_results

7. LOW (Line 13919, 14012):
   Add validation before to_sql():
   - Check (college_id + state + address) uniqueness
   - Report violations and ask for confirmation
   - Option to auto-fix by keeping highest confidence match

================================================================================
CONCLUSION
================================================================================

The false match issue stems from address validation being OPTIONAL in the 
matching pipeline but MANDATORY in integrity checks. Matches that pass 
address validation are correctly stored, but unvalidated matches are also 
stored, revealing duplicates when link tables are rebuilt.

FIX: Make address validation mandatory before ANY database write and 
deduplicate results by address in all batch processing paths.

