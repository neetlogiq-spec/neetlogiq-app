#!/usr/bin/env tsx

import * as XLSX from 'xlsx';
import path from 'path';

interface ExcelAnalysis {
  fileName: string;
  sheets: {
    name: string;
    rowCount: number;
    columns: string[];
    sampleData: any;
  }[];
}

async function analyzeExcelFiles() {
  console.log('üîç === Excel Data Structure Analysis ===\n');

  const dataDir = path.join(process.cwd(), 'data/Foundation');
  const files = [
    'medical.xlsx',
    'dental.xlsx', 
    'dnb.xlsx',
    'CATEGORY.xlsx',
    'QUOTA.xlsx',
    'STATES OF INDIA.xlsx'
  ];

  const analyses: ExcelAnalysis[] = [];

  for (const file of files) {
    const filePath = path.join(dataDir, file);
    console.log(`üìÑ Analyzing ${file}:`);
    
    try {
      const workbook = XLSX.readFile(filePath);
      const analysis: ExcelAnalysis = {
        fileName: file,
        sheets: []
      };

      for (const sheetName of workbook.SheetNames) {
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        const sheetAnalysis = {
          name: sheetName,
          rowCount: jsonData.length,
          columns: jsonData.length > 0 ? Object.keys(jsonData[0]) : [],
          sampleData: jsonData.length > 0 ? jsonData[0] : null
        };

        analysis.sheets.push(sheetAnalysis);
        
        console.log(`  üìä Sheet: ${sheetName}`);
        console.log(`  üìà Rows: ${jsonData.length}`);
        
        if (jsonData.length > 0) {
          console.log(`  üìã Columns: ${Object.keys(jsonData[0]).join(', ')}`);
          console.log(`  üìù Sample: ${JSON.stringify(jsonData[0])}`);
        }
        console.log();
      }

      analyses.push(analysis);
      console.log('---\n');

    } catch (error) {
      console.error(`‚ùå Error analyzing ${file}:`, error);
    }
  }

  // Generate summary
  console.log('üìä === Summary ===');
  let totalRecords = 0;
  const collegeFiles = analyses.filter(a => ['medical.xlsx', 'dental.xlsx', 'dnb.xlsx'].includes(a.fileName));
  
  collegeFiles.forEach(analysis => {
    const records = analysis.sheets.reduce((sum, sheet) => sum + sheet.rowCount, 0);
    totalRecords += records;
    console.log(`${analysis.fileName}: ${records} records`);
  });

  console.log(`\nüéØ Total College Records: ${totalRecords}`);
  console.log(`üè• Expected 2400+ colleges: ${totalRecords >= 2400 ? '‚úÖ Target met' : '‚ö†Ô∏è Below target'}`);

  return analyses;
}

// Run the analysis
analyzeExcelFiles().catch(console.error);